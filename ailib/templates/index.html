<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mad Libs Story</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .fillable:hover {
            cursor: pointer;
            background-color: #e0e0e0;
        }

        .autofill-btn {
            display: none;
            position: absolute;
        }

        .fillable:hover .autofill-btn {
            display: block;
        }
    </style>
</head>

<body>
    {% include 'nav.html' %}
    <div class="container mt-5">
        <textarea class="form-control" id="storyArea" rows="10" placeholder="Generating a story may take up to 1 minute..."></textarea>
        <div class="row mt-3">
            <!-- Button -->
            <div class="col-md-4">
                <button class="btn btn-primary w-100" onclick="getStory()">
                    Get New Story 
                    <span class="spinner-border spinner-border-sm" role="status" id="loadingSpinner" style="display: none;"></span>
                </button>
            </div>
            
            <!-- Length Dropdown -->
            <div class="col-md-4 d-flex align-items-center">
                <label for="storyLength" class="form-label mb-0 me-2">Story Length</label>
                <select class="form-select" id="storyLength">
                    {% for length in STORY_LENGTHS %}
                        <option value="{{ length }}">{{ length }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Type Dropdown -->
            <div class="col-md-4 d-flex align-items-center">
                <label for="storyType" class="form-label mb-0 me-2">Story Type</label>
                <select class="form-select" id="storyType">
                    {% for type in STORY_TYPES %}
                        <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <script>
        function getStory() {
            const storyLength = $('#storyLength').val();
            const storyType = $('#storyType').val();
        
            // Show the spinner
            $('#loadingSpinner').show();
        
            // Include the dropdown values in the GET request as query parameters
            $.get(`/gen_lib?length=${storyLength}&type=${storyType}`, function(data) {
                $('#storyArea').val(data.story);
                adjustTextareaHeight('storyArea');
            
                // Send the story to get the fillable items
                $.post('/list_fills', { story: data.story }, function(fillData) {
                    // Create textboxes for each fillable item
                    let fillInputs = '<div class="mt-3">';
                    for (let fill of fillData.fills) {
                        fillInputs += `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control fill-input" placeholder="${fill}" data-fill="${fill}">
                                <button class="btn btn-primary enter-btn" style="display:none;">Enter</button>
                                <button class="btn btn-secondary autofill-btn" style="display:none;" onclick="autoFillWord('${fill}')">AutoFill</button>
                            </div>`;
                    }
                    fillInputs += '</div>';
                
                    // Insert the textboxes between the buttons/dropdowns and the story textarea
                    $('#storyArea').before(fillInputs);
                });
            
            }).always(function() {
                // Hide the spinner once the request is complete
                $('#loadingSpinner').hide();
            });
        }


        function highlightFillables() {
            let storyText = $('#storyArea').val();
            let regex = /\[[a-zA-Z0-9]+\]/g;
            let match;

            while (match = regex.exec(storyText)) {
                let word = match[0];
                let span = `<span class="fillable" data-text="${word}">${word} <button class="autofill-btn btn btn-sm btn-secondary" onclick="autofill('${word}')">Autofill</button></span>`;
                storyText = storyText.replace(word, span);
            }

            $('#storyArea').html(storyText);
        }

        function autofill(word) {
            $.post('/auto_gen_word', { prompt: word }, function (data) {
                let replaceWith = data.word;
                let storyText = $('#storyArea').html();
                let regex = new RegExp(`\\[${word}\\]`);
                storyText = storyText.replace(regex, replaceWith);
                $('#storyArea').html(storyText);
            });
        }

        function adjustTextareaHeight(textareaId) {
            const textarea = document.getElementById(textareaId);
            const lines = textarea.value.split('\n').length;
            textarea.rows = Math.max(lines, 1);  // Ensure at least 1 row
        }

        function autoFillWord(fillType) {
            $.post('/auto_gen_word', { prompt: `Please give a ${fillType}` }, function(data) {
                $(`input[data-fill="${fillType}"]`).val(data.word);
            });
        }

        $(document).on('focus', '.fill-input', function() {
            $(this).siblings('.enter-btn, .autofill-btn').show();
        });

        $(document).on('blur', '.fill-input', function() {
            // Optionally, you can hide the buttons when the textbox loses focus
            $(this).siblings('.enter-btn, .autofill-btn').hide();
        });
    </script>
</body>

</html>
